/* eslint-env browser */

/* global Webex */

/* eslint-disable no-console */
/* eslint-disable require-jsdoc */

// This is one way you might programattically determine your redirectURL
// depending on where you've deployed your app, but you're probably better off
// having development/staging/production builds and injecting directly from the
// environment.
let redirectURL = `${window.location.protocol}//${window.location.host}`;

if (window.location.pathname) {
  redirectURL += window.location.pathname;
}

// Declare some globals that we'll need throughout.
const webex = window.webex = Webex.init({
  config: {
    logger: {
      level: 'debug'
    },
    meetings: {
      reconnection: {
        enabled: true
      }
    },
    // Any other sdk config we need
    credentials: {
      client_id:
          'C5187aaf0088ffc0d9c32a5281559090733968ba9b978dbaeb91bd0f6a4e86862',
      redirectURL,
      scope: 'spark:all spark:kms'
    }
  }
});

// Save fields in localStorage so we don't have to retype them
// every time we reload the page.
[
  'access-token'
].forEach((id) => {
  const el = document.getElementById(id);

  el.value = localStorage.getItem(id);
  el.addEventListener('change', (event) => {
    localStorage.setItem(id, event.target.value);
  });
});

// Connect to Webex and listen for message events.
function authorize() {
  if (webex.canAuthorize) {
    return Promise.resolve(webex.canAuthorize);
  }

  return Promise.reject(webex.canAuthorize);
}

// Update the UI.
function updateStatus(authorized) {
  const status = document.getElementById('connection-status');

  document.getElementById('access-token')
    .value = this.webex.credentials.supertoken.access_token;
  if (authorized) {
    status.innerHTML = 'initialized';
    status.classList.remove('label-warning');
    status.classList.remove('label-error');
    status.classList.add('label-success');
    document.getElementById('connect').disabled = true;
  }
  else {
    status.innerHTML = 'unauthorized';
    status.classList.remove('label-warning');
    status.classList.add('label-error');
  }
}

// Setting up our event handler on our button
webex.once('ready', () => {
  document.getElementById('access-token-save')
    .addEventListener('submit', (event) => {
    // Don't reload the page when we submit the form.
      event.preventDefault();

      webex.authorization.initiateLogin();
    });

  authorize()
    .then(() => {
      console.log('connected');
      webex.messages.listen()
        .then(() => {
          console.log('listening to message events');
          updateStatus(true);
          webex.messages.on('created', (message) => {
            console.log('message created event:');
            console.log(message);
          });
          webex.messages.on('deleted', (message) => {
            console.log('message deleted event:');
            console.log(message);
          });
        })
        .catch((err) => {
          console.error(`error listening to messages: ${err}`);
          updateStatus(false);
        });

      webex.attachmentActions.listen()
        .then(() => {
          console.log('listening to attachmentAction events');
          updateStatus(true);
          webex.attachmentActions.on('created', (attachmentAction) => {
            console.log('attachmentAction created event:');
            console.log(attachmentAction);
          });
        })
        .catch((err) => {
          console.error(`error listening to attachmentActions: ${err}`);
          updateStatus(false);
        });

      webex.memberships.listen()
        .then(() => {
          console.log('listening to membership events');
          updateStatus(true);
          webex.memberships.on('created', (membership) => {
            console.log('membership created event');
            console.log(membership);
          });
          webex.memberships.on('deleted', (membership) => {
            console.log('membership deleted event');
            console.log(membership);
          });
          webex.memberships.on('updated', (membership) => {
            console.log('membership updated event');
            console.log(membership);
          });
          webex.memberships.on('seen', (membership) => {
            console.log('membership seen (read receipt) event');
            console.log(membership);
          });
        })
        .catch((err) => {
          console.error(`error listening to memberships: ${err}`);
          updateStatus(false);
        });

      webex.rooms.listen()
        .then(() => {
          console.log('listening to room events');
          updateStatus(true);
          webex.rooms.on('created', (room) => {
            console.log('room created event');
            console.log(room);
          });
          webex.rooms.on('updated', (room) => {
            console.log('room updated event');
            console.log(room);
          });
        })
        .catch((err) => {
          console.error(`error listening to rooms: ${err}`);
          updateStatus(false);
        });
    })
    .catch((err) => {
      console.error(`cannot authorize: ${err}`);
    });

  if (webex.canAuthorize) {
    document.getElementById('access-token').value =
      this.webex.credentials.supertoken.access_token;
  }
});

